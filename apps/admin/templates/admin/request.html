{% extends 'places/base.html' %}
{% load static %}
{% block head %}
{{block.super}}
<style>
    .table-places {
        display: inline-table;
        border-collapse: separate;
        border-spacing: 4px;
        text-align: center;
    }

    .table-places td {
        text-align: center;
        padding: .3rem .7rem !important;
        color: white !important;
        margin: 2px !important;
    }

    .table-places tr {
        border: 0 transparent !important;
    }

    td[data-status="available"] {
        cursor: pointer;
    }

    td.selected {
        outline: 3px solid #332D2D;
    }

    td[data-status="unavailable"] {
        background-color: #9FA6B2 !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{% static 'js/request.js' %}" type="module" defer></script>
<script src="{% static 'js/easytimer.min.js' %}" defer></script>
{% endblock head %}
{% load static %}
{% block main %}
<div class="container-fluid p-5">
    <form method="post">
        {% csrf_token %}
        <div class="row gx-xl-5">
            <div class="col-xl-3">
                <div class="shadow-4 bg-white rounded-5 overflow-hidden mb-4">
                    <div class="bg-light p-4 text-center">
                        <h5 class="mb-0">Asigna un Estatus</h5>
                    </div>
                    <div class="p-4">
                        {% if not object.estatus or object.estatus == 'resolved' %}
                        {% if object.estatus == 'resolved' %}
                        <h1 class="text-center"><span class="badge rounded-pill badge-primary mb-2">Solventado</span></h1>
                        {% endif %}
                        <button name="validated" type="submit" data-mdb-ripple-init data-mdb-ripple-color="dark"
                            class="btn btn-lg btn-rounded btn-outline-success shadow-0 w-100"><i
                                class="fas fa-check me-2"></i>Validar</button>
                        <button name="pending" type="submit"
                            class="btn btn-outline-warning btn-lg btn-rounded shadow-0 w-100 my-3"><i
                                class="fas fa-triangle-exclamation me-2"></i>Observar</button>
                        <button name="rejected" type="submit"
                            class="btn btn-outline-danger btn-lg btn-rounded shadow-0 w-100"><i
                                class="fas fa-ban me-2"></i>Rechazar</button>
                        {% elif object.estatus == 'validated' %}
                        <h1 class="text-center"><span class="badge rounded-pill badge-success">Validado</span></h1>
                        {% elif object.estatus == 'rejected' %}
                        <h1 class="text-center"><span class="badge rounded-pill badge-danger">Rechazado</span></h1>
                        {% elif object.estatus == 'pending' %}
                        <h1 class="text-center"><span class="badge rounded-pill badge-warning">Observado</span></h1>
                        {% endif %}
                    </div>
                    <div class="bg-light p-4 text-center">
                        <h5 class="mb-0">Historial de Validaciones</h5>
                    </div>
                    <div class="p-4">
                        <button type="button" class="btn btn-primary btn-lg btn-rounded shadow-0 w-100"
                            data-mdb-toggle="modal" data-mdb-target="#modal-validations">
                            <i class="fas fa-list-check me-2"></i>Ver Historial
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-xl-9 mb-4 mb-lg-0">
                {% include 'base/validations.html' %}
                <div
                    class="shadow-4 bg-white rounded-5 mb-4 overflow-hidden p-4 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas fa-clipboard-list me-3 green-text"></i>Solicitud {{object.folio}}
                    </h4>
                    <a class="btn btn-lg btn-link btn-rounded d-none d-sm-block" href="{% url 'admin:main' %}"
                        role="button">Ver
                        todo<i class="fas fa-arrow-right ms-2"></i></a>
                </div>
                {% comment %}
                {% if object.estatus == 'validated' %}
                {% if not selected_places %}
                <div class="alert" role="alert" data-mdb-color="warning">
                    <i class="fas fa-exclamation-triangle me-3"></i>Para continuar con el proceso de la Solicitud <a
                        href="#places" class="btn btn-sm btn-warning shadow-0 ms-2">Asigna un espacio</a>
                </div>
                {% endif %}
                {% endif %}
                {% endcomment %}
                <div class="shadow-4 bg-white rounded-5 p-4">
                    <ul class="list-group list-group-light">
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">{{object.fecha_reg}} hrs.</div>
                                <small>Fecha de registro</small>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">{{object.folio}}</div>
                                <small>Folio</small>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">{{object.cantidad_espacios}}</div>
                                <small>Espacios Seleccionados</small>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="factura" />
                                    {{object.get_factura_display}}
                                </div>
                                <small>¿Requiere Factura?</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% if object.regimen_fiscal %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="regimen_fiscal" />
                                    {{object.get_regimen_fiscal_display}}
                                </div>
                                <small>Régimen Fiscal</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="nombre" />
                                    {{object.nombre}}
                                </div>
                                <small>Nombre o Razón Social</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% if object.nombre_replegal %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="nombre_replegal" />
                                    {{object.nombre_replegal}}
                                </div>
                                <small>Nombre del Representante Legal</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.rfc_txt %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="rfc_txt" />
                                    {{object.rfc_txt}}
                                </div>
                                <small>RFC</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.curp_txt %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="curp_txt" />
                                    {{object.curp_txt}}
                                </div>
                                <small>CURP</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="calle" />
                                    {{object.calle}}
                                </div>
                                <small>Calle</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="no_calle" />
                                    {{object.no_calle}}
                                </div>
                                <small>Número de Casa</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="colonia" />
                                    {{object.colonia}}
                                </div>
                                <small>Colonia</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="codigo_postal" />
                                    {{object.codigo_postal}}
                                </div>
                                <small>Código Postal</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="estado" />
                                    {{object.get_estado_display}}
                                </div>
                                <small>Estado</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <input class="form-check-input me-1" type="checkbox" value="municipio" />
                                    {{object.municipio}}
                                </div>
                                <small>Municipio</small>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% if object.constancia_fiscal %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold mb-2">
                                    <input class="form-check-input me-1" type="checkbox" value="constancia_fiscal" />
                                    Constancia de Situación Fiscal
                                </div>
                                <a href="{{object.constancia_fiscal.url}}" target="_blank" type="button"
                                    class="btn btn-sm btn-light"><i class="fas fa-eye me-2"></i>Ver documento</a>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.comprobante_domicilio %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold mb-2">
                                    <input class="form-check-input me-1" type="checkbox"
                                        value="comprobante_domicilio" />
                                    Comprobante de Domicilio
                                </div>
                                <a href="{{object.comprobante_domicilio.url}}" target="_blank" type="button"
                                    class="btn btn-sm btn-light"><i class="fas fa-eye me-2"></i>Ver documento</a>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.acta_constitutiva %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold mb-2">
                                    <input class="form-check-input me-1" type="checkbox" value="acta_constitutiva" />
                                    Acta Constitutiva
                                </div>
                                <a href="{{object.acta_constitutiva.url}}" target="_blank" type="button"
                                    class="btn btn-sm btn-light"><i class="fas fa-eye me-2"></i>Ver documento</a>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.identificacion %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold mb-2">
                                    <input class="form-check-input me-1" type="checkbox" value="identificacion" />
                                    Identificación Oficial
                                </div>
                                <a href="{{object.identificacion.url}}" target="_blank" type="button"
                                    class="btn btn-sm btn-light"><i class="fas fa-eye me-2"></i>Ver documento</a>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if object.curp %}
                        <li
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start p-3">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold mb-2">
                                    <input class="form-check-input me-1" type="checkbox" value="curp" />
                                    CURP
                                </div>
                                <a href="{{object.curp.url}}" target="_blank" type="button"
                                    class="btn btn-sm btn-light"><i class="fas fa-eye me-2"></i>Ver documento</a>
                            </div>
                            <div>
                                <div class="form-outline" data-mdb-input-init>
                                    <textarea class="form-control d-none" rows="3"></textarea>
                                    <label class="form-label">Observaciones</label>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </div>


                {% comment %}
                {% if object.estatus == 'validated' %}
                {% if not selected_places %}
                <div data-mdb-alert-init="" class="alert fade alert-success alert-fixed" id="alert-success" role="alert"
                    data-mdb-color="success" data-mdb-position="top-center" data-mdb-stacking="true"
                    data-mdb-append-to-body="true" data-mdb-hidden="true" data-mdb-autohide="true" data-mdb-delay="1000"
                    data-mdb-alert-initialized="true">
                    <i class="fas fa-check-circle me-2"></i> <b>Lugares Actualizados</b>
                </div>
                <div data-mdb-alert-init="" class="alert fade alert-warning alert-fixed" id="alert-warning" role="alert"
                    data-mdb-color="warning" data-mdb-position="top-center" data-mdb-stacking="true"
                    data-mdb-append-to-body="true" data-mdb-hidden="true" data-mdb-autohide="true" data-mdb-delay="2000"
                    data-mdb-alert-initialized="true">
                    <i class="fas fa-ban me-2"></i> <b>Selección Cancelada</b>
                </div>
                <div class="shadow-4 bg-white rounded-5 my-4 overflow-hidden p-4 d-flex justify-content-between align-items-center"
                    id="places">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas fa-map-pin me-3 green-text"></i>Selecciona un espacio disponible
                    </h4>
                    <button type="button" id="reload-places" class="btn btn-lg btn-link btn-rounded"><i
                            class="fas fa-arrows-rotate fa-lg"></i></button>
                </div>
                <p class="note note-info mb-4">
                    Al <b>Preseleccionar</b> los lugares se bloquearán por <b>35 minutos</b> y no serán visibles
                    para otros módulos.
                    Si no se confirma la selección, los lugares volverán a estar disponibles después de ese tiempo.
                </p>
                <div class="shadow-4 bg-white rounded-5 p-5 mb-4">
                    <div class="table-responsive">
                        <table class="table table-places m-0"></table>
                    </div>
                    <button type="button" id="preselection" disabled
                        class="btn btn-lg btn-rounded btn-primary shadow-0 w-100 mt-3"><i
                            class="fas fa-check me-2"></i>Preseleccionar lugares</button>
                </div>
                {% else %}
                <div class="shadow-4 bg-white rounded-5 my-4 overflow-hidden p-4 d-flex justify-content-between align-items-center"
                    id="places">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas fa-map-pin me-3 green-text"></i>Espacios Seleccionados
                    </h4>
                </div>
                <div class="shadow-4 bg-white rounded-5 p-5 mb-4">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Folio</th>
                                <th scope="col">Número del lugar</th>
                                <th scope="col">Sección</th>
                                <th scope="col">Precio</th>
                                <th scope="col">Fecha de asignación</th>
                                <th>Gafete</th>
                                <th>Estacionamiento</th>
                                <th>Suministros</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sp in selected_places %}
                            <tr>
                                <th scope="row">{{sp.folio_bd}}</th>
                                <td>{{sp.text}}</td>
                                <td>{{sp.section}}</td>
                                <td>${{sp.price}}</td>
                                <td>{{sp.date}}</td>
                                <td class="text-center"><a href="{% static 'docs/gafete.pdf' %}" download><i
                                            class="fas fa-download"></i></a></td>
                                <td class="text-center"><a href="{% static 'docs/estacionamiento.pdf' %}" download><i
                                            class="fas fa-download"></i></a></td>
                                <td class="text-center"><a href="{% static 'docs/suministros.pdf' %}" download><i
                                            class="fas fa-download"></i></a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                {% endif %}
                {% endcomment %}
            </div>
        </div>
    </form>
</div>
<!-- Modal Validations -->
<div class="modal fade" id="modal-validations" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Historial de Validaciones</h5>
                <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table align-middle mb-0 bg-white">
                    <thead class="bg-light">
                        <tr>
                            <th>Estatus</th>
                            <th>Fecha</th>
                            <th>Comentarios</th>
                            <th>Campos seleccionados</th>
                            <th>Validador</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vl in object.validaciones.all %}
                        <tr>
                            <td>
                                {% if vl.estatus == 'validated' %}
                                <h6 class="badge rounded-pill badge-success">Validado</span>
                                    {% elif vl.estatus == 'rejected' %}
                                    <span class="badge rounded-pill badge-danger">Rechazado</span>
                                    {% elif vl.estatus == 'pending' %}
                                    <span class="badge rounded-pill badge-warning">Observado</span>
                                    {% elif vl.estatus == 'resolved' %}
                                    <span class="badge rounded-pill badge-primary">Solventado por el usuario</span>
                                    {% else %}
                                    <span class="badge rounded-pill badge-secondary">No asignado</span>
                                    {% endif %}
                            </td>
                            <td>{{vl.fecha_reg}}</td>
                            <td>{{vl.comentarios|default:"No especificado"}}</td>
                            <td>{{vl.campos|default:"No especificado"}}</td>
                            <td>{{vl.validador}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-mdb-ripple-init
                    data-mdb-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<!-- timer modal -->
<div class="modal fade" data-mdb-backdrop="static" data-mdb-keyboard="false" id="modal-timer" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title">Confirmar lugares seleccionados</h5>
            </div>
            <div class="modal-body">
                <input type="hidden" id="request-uuid" value="{{object.uuid}}">
                <h1 id="timer" class="text-center">00:00:00</h1>
            </div>
            <div class="modal-footer">
                <button type="button" id="selection" class="btn btn-lg btn-rounded btn-primary shadow-0 w-100"><i
                        class="fas fa-check me-2"></i>Confirmar lugares</button>
                <button data-mdb-dismiss="modal" type="button" id="selection"
                    class="btn btn-lg btn-rounded btn-danger shadow-0 w-100"><i
                        class="fas fa-ban me-2"></i>Cancelar</button>
            </div>
        </div>
    </div>
</div>

{% endblock main %}